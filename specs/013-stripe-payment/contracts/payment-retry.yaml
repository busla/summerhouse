openapi: 3.1.0
info:
  title: Payment Retry API
  description: |
    Retry failed payments by creating a new Stripe Checkout session.

    This endpoint allows guests to retry payment after a previous
    attempt failed (declined card, network error, etc.).
  version: 1.0.0

servers:
  - url: https://api.booking.example/api
    description: Production server
  - url: https://api-dev.booking.example/api
    description: Development server
  - url: http://localhost:3001/api
    description: Local development

tags:
  - name: Payments
    description: Payment processing endpoints

paths:
  /payments/{reservation_id}/retry:
    post:
      tags:
        - Payments
      summary: Retry failed payment
      description: |
        Creates a new Stripe Checkout session to retry a failed payment.

        **Authentication**: JWT required (reservation owner only)

        **Constraints** (FR-025):
        - Maximum 3 retry attempts per reservation
        - Reservation must be in pending status (not cancelled/confirmed)
        - Availability must still be held (within 24-hour window)

        **Flow**:
        1. Validates reservation exists and belongs to authenticated user
        2. Checks retry limit (max 3 attempts)
        3. Creates new Stripe Checkout session
        4. Returns checkout URL for redirect

        **Notes**:
        - Can optionally specify a different payment method
        - Uses same payment method as previous attempt if not specified
      operationId: retryPayment
      security:
        - cognitoJwt: []
      parameters:
        - name: reservation_id
          in: path
          required: true
          description: Reservation ID to retry payment for
          schema:
            type: string
          example: "RES-2026-ABC123"
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PaymentRetryRequest'
            examples:
              sameMethod:
                summary: Retry with same payment method
                value: {}
              differentMethod:
                summary: Retry with different method
                value:
                  payment_method: "card"
              withUrls:
                summary: With custom redirect URLs
                value:
                  success_url: "https://summerhouse.example/booking/success"
                  cancel_url: "https://summerhouse.example/booking/retry-cancel"
      responses:
        '200':
          description: Retry checkout session created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CheckoutSessionResponse'
              example:
                payment_id: "PAY-2026-GHI789"
                checkout_session_id: "cs_test_retry123"
                checkout_url: "https://checkout.stripe.com/c/pay/cs_test_retry123"
                expires_at: "2026-01-03T11:00:00Z"
                amount: 112500
                currency: "EUR"
                attempt_number: 2
        '400':
          description: Invalid retry request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                alreadyPaid:
                  summary: Reservation already paid
                  value:
                    success: false
                    error_code: "ERR_400"
                    message: "Reservation is already paid"
                    recovery: "No payment needed - booking is confirmed"
                cancelled:
                  summary: Reservation cancelled
                  value:
                    success: false
                    error_code: "ERR_400"
                    message: "Cannot pay for cancelled reservations"
                    recovery: "Create a new reservation"
                maxRetries:
                  summary: Maximum retries exceeded
                  value:
                    success: false
                    error_code: "ERR_400"
                    message: "Maximum payment attempts (3) exceeded"
                    recovery: "Please contact support for assistance"
                    details:
                      attempts: 3
                      max_attempts: 3
                noPreviousPayment:
                  summary: No previous payment to retry
                  value:
                    success: false
                    error_code: "ERR_400"
                    message: "No previous payment found. Use POST /api/payments/checkout-session instead."
                    recovery: "Create a new checkout session"
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error_code: "ERR_AUTH"
                message: "JWT token required"
                recovery: "Sign in to continue"
        '403':
          description: Not authorized (not reservation owner)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error_code: "ERR_007"
                message: "You can only retry payments for your own reservations"
                recovery: "Verify you're signed in with the correct account"
        '404':
          description: Reservation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                error_code: "ERR_006"
                message: "Reservation not found"
                recovery: "Verify the reservation ID"

components:
  schemas:
    PaymentRetryRequest:
      type: object
      properties:
        payment_method:
          type: string
          enum:
            - card
            - paypal
            - bank_transfer
          description: |
            Payment method to use for retry.
            If not specified, uses the same method as the previous attempt.
            Note: Only 'card' is supported for Stripe.
        success_url:
          type: string
          format: uri
          description: URL to redirect after successful payment
        cancel_url:
          type: string
          format: uri
          description: URL to redirect if payment is cancelled

    CheckoutSessionResponse:
      type: object
      required:
        - payment_id
        - checkout_session_id
        - checkout_url
        - expires_at
        - amount
        - currency
      properties:
        payment_id:
          type: string
          description: New payment ID for this retry attempt
          examples:
            - "PAY-2026-GHI789"
        checkout_session_id:
          type: string
          description: Stripe Checkout Session ID
        checkout_url:
          type: string
          format: uri
          description: URL to redirect user to Stripe Checkout
        expires_at:
          type: string
          format: date-time
          description: Session expiry (30 minutes)
        amount:
          type: integer
          minimum: 0
          description: Payment amount in EUR cents
        currency:
          type: string
          default: "EUR"
        attempt_number:
          type: integer
          minimum: 1
          maximum: 3
          description: Which payment attempt this is (1-3)

    ErrorResponse:
      type: object
      required:
        - success
        - error_code
        - message
        - recovery
      properties:
        success:
          type: boolean
          const: false
        error_code:
          type: string
        message:
          type: string
        recovery:
          type: string
        details:
          type: object
          additionalProperties: true

  securitySchemes:
    cognitoJwt:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Cognito JWT token with openid scope
