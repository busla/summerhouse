{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "openapi-rest-api.schema.json",
  "title": "OpenAPI REST API Output Schema",
  "description": "JSON Schema for the OpenAPI specification generated by generate_openapi.py with AWS API Gateway REST API extensions (v3.0 - migrated from HTTP API)",
  "type": "object",
  "required": ["openapi", "info", "paths", "components"],
  "properties": {
    "openapi": {
      "type": "string",
      "pattern": "^3\\.0\\.[0-9]+$",
      "description": "OpenAPI version (3.0.x)"
    },
    "info": {
      "type": "object",
      "required": ["title", "version"],
      "properties": {
        "title": {
          "type": "string",
          "description": "API title from FastAPI app"
        },
        "version": {
          "type": "string",
          "description": "API version from FastAPI app"
        },
        "description": {
          "type": "string",
          "description": "API description from FastAPI app"
        }
      }
    },
    "components": {
      "type": "object",
      "required": ["securitySchemes"],
      "properties": {
        "securitySchemes": {
          "type": "object",
          "required": ["CognitoAuthorizer"],
          "properties": {
            "CognitoAuthorizer": {
              "$ref": "#/$defs/CognitoUserPoolsScheme"
            }
          }
        },
        "schemas": {
          "type": "object",
          "description": "Pydantic model schemas from FastAPI",
          "additionalProperties": true
        }
      }
    },
    "paths": {
      "type": "object",
      "description": "API paths with AWS REST API integrations and OPTIONS methods for CORS",
      "additionalProperties": {
        "$ref": "#/$defs/PathItem"
      }
    }
  },
  "$defs": {
    "CognitoUserPoolsScheme": {
      "type": "object",
      "description": "apiKey security scheme with Cognito User Pools authorizer (REST API)",
      "required": ["type", "name", "in", "x-amazon-apigateway-authtype", "x-amazon-apigateway-authorizer"],
      "properties": {
        "type": {
          "type": "string",
          "const": "apiKey",
          "description": "REST API uses apiKey type for Cognito (not oauth2)"
        },
        "name": {
          "type": "string",
          "const": "Authorization",
          "description": "Header name containing the token"
        },
        "in": {
          "type": "string",
          "const": "header",
          "description": "Token location"
        },
        "x-amazon-apigateway-authtype": {
          "type": "string",
          "const": "cognito_user_pools",
          "description": "REST API authorizer type identifier"
        },
        "x-amazon-apigateway-authorizer": {
          "$ref": "#/$defs/CognitoUserPoolsAuthorizer"
        }
      }
    },
    "CognitoUserPoolsAuthorizer": {
      "type": "object",
      "description": "x-amazon-apigateway-authorizer for Cognito User Pools (REST API)",
      "required": ["type", "providerARNs"],
      "properties": {
        "type": {
          "type": "string",
          "const": "cognito_user_pools",
          "description": "REST API authorizer type"
        },
        "providerARNs": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^arn:aws:cognito-idp:[a-z]+-[a-z]+-[0-9]+:[0-9]+:userpool/[a-z]+-[a-z]+-[0-9]+_[A-Za-z0-9]+$"
          },
          "minItems": 1,
          "maxItems": 1,
          "description": "Cognito User Pool ARN (full ARN, not just pool ID)"
        }
      }
    },
    "PathItem": {
      "type": "object",
      "description": "OpenAPI path item with operations and OPTIONS for CORS",
      "properties": {
        "options": {
          "$ref": "#/$defs/OptionsOperation",
          "description": "CORS preflight handler (required for REST API)"
        }
      },
      "additionalProperties": {
        "$ref": "#/$defs/Operation"
      }
    },
    "OptionsOperation": {
      "type": "object",
      "description": "OPTIONS method for CORS preflight (mock integration)",
      "required": ["responses", "x-amazon-apigateway-integration"],
      "properties": {
        "summary": {
          "type": "string",
          "const": "CORS preflight"
        },
        "responses": {
          "type": "object",
          "required": ["200"],
          "properties": {
            "200": {
              "$ref": "#/$defs/CORSResponse"
            }
          }
        },
        "x-amazon-apigateway-integration": {
          "$ref": "#/$defs/MockIntegration"
        }
      }
    },
    "CORSResponse": {
      "type": "object",
      "description": "CORS preflight response definition",
      "required": ["description", "headers"],
      "properties": {
        "description": {
          "type": "string",
          "const": "CORS preflight response"
        },
        "headers": {
          "type": "object",
          "required": ["Access-Control-Allow-Origin", "Access-Control-Allow-Methods", "Access-Control-Allow-Headers"],
          "properties": {
            "Access-Control-Allow-Origin": {
              "type": "object",
              "properties": {
                "schema": { "type": "object" }
              }
            },
            "Access-Control-Allow-Methods": {
              "type": "object",
              "properties": {
                "schema": { "type": "object" }
              }
            },
            "Access-Control-Allow-Headers": {
              "type": "object",
              "properties": {
                "schema": { "type": "object" }
              }
            }
          }
        }
      }
    },
    "MockIntegration": {
      "type": "object",
      "description": "Mock integration for CORS OPTIONS responses",
      "required": ["type", "requestTemplates", "responses"],
      "properties": {
        "type": {
          "type": "string",
          "const": "mock",
          "description": "Mock integration type for CORS"
        },
        "requestTemplates": {
          "type": "object",
          "required": ["application/json"],
          "properties": {
            "application/json": {
              "type": "string",
              "const": "{\"statusCode\": 200}",
              "description": "Request template returning 200"
            }
          }
        },
        "responses": {
          "type": "object",
          "required": ["default"],
          "properties": {
            "default": {
              "$ref": "#/$defs/MockResponse"
            }
          }
        }
      }
    },
    "MockResponse": {
      "type": "object",
      "description": "Mock integration response with CORS headers",
      "required": ["statusCode", "responseParameters"],
      "properties": {
        "statusCode": {
          "type": "string",
          "const": "200"
        },
        "responseParameters": {
          "type": "object",
          "required": [
            "method.response.header.Access-Control-Allow-Methods",
            "method.response.header.Access-Control-Allow-Headers",
            "method.response.header.Access-Control-Allow-Origin"
          ],
          "properties": {
            "method.response.header.Access-Control-Allow-Methods": {
              "type": "string",
              "description": "Allowed methods (e.g., 'GET,POST,PUT,DELETE,OPTIONS,PATCH')"
            },
            "method.response.header.Access-Control-Allow-Headers": {
              "type": "string",
              "description": "Allowed headers (e.g., 'Content-Type,Authorization,X-Requested-With,X-Amz-Date')"
            },
            "method.response.header.Access-Control-Allow-Origin": {
              "type": "string",
              "description": "Allowed origin (e.g., 'https://example.com' or '*')"
            }
          }
        }
      }
    },
    "Operation": {
      "type": "object",
      "description": "OpenAPI operation with AWS REST API Lambda proxy integration",
      "required": ["x-amazon-apigateway-integration"],
      "properties": {
        "summary": { "type": "string" },
        "description": { "type": "string" },
        "operationId": { "type": "string" },
        "tags": {
          "type": "array",
          "items": { "type": "string" }
        },
        "security": {
          "type": "array",
          "description": "Security requirements (empty array for public routes)",
          "items": {
            "type": "object",
            "properties": {
              "CognitoAuthorizer": {
                "type": "array",
                "items": { "type": "string" },
                "description": "Scopes (empty for Cognito User Pools)"
              }
            }
          }
        },
        "parameters": {
          "type": "array",
          "items": { "$ref": "#/$defs/Parameter" }
        },
        "requestBody": {
          "type": "object",
          "description": "Request body schema"
        },
        "responses": {
          "type": "object",
          "description": "Response schemas"
        },
        "x-amazon-apigateway-integration": {
          "$ref": "#/$defs/LambdaProxyIntegration"
        }
      }
    },
    "Parameter": {
      "type": "object",
      "required": ["name", "in"],
      "properties": {
        "name": { "type": "string" },
        "in": {
          "type": "string",
          "enum": ["path", "query", "header", "cookie"]
        },
        "required": { "type": "boolean" },
        "schema": { "type": "object" },
        "description": { "type": "string" }
      }
    },
    "LambdaProxyIntegration": {
      "type": "object",
      "description": "x-amazon-apigateway-integration for Lambda proxy (REST API format)",
      "required": ["type", "httpMethod", "uri", "passthroughBehavior"],
      "properties": {
        "type": {
          "type": "string",
          "const": "aws_proxy",
          "description": "REST API uses lowercase 'aws_proxy' (not 'AWS_PROXY')"
        },
        "httpMethod": {
          "type": "string",
          "const": "POST",
          "description": "Lambda invocations are always POST"
        },
        "uri": {
          "type": "string",
          "pattern": "^arn:aws:apigateway:[a-z]+-[a-z]+-[0-9]+:lambda:path/2015-03-31/functions/arn:aws:lambda:[a-z]+-[a-z]+-[0-9]+:[0-9]+:function:[a-zA-Z0-9_-]+/invocations$",
          "description": "Lambda invocation URI"
        },
        "passthroughBehavior": {
          "type": "string",
          "const": "when_no_match",
          "description": "REST API requires passthroughBehavior (HTTP API doesn't)"
        }
      },
      "not": {
        "required": ["payloadFormatVersion"],
        "description": "REST API does not support payloadFormatVersion (always 1.0)"
      }
    }
  }
}
