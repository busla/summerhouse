# https://taskfile.dev
# Summerhouse Booking Platform - Task Runner
#
# IMPORTANT: All Terraform commands MUST be run via this Taskfile.
# Syntax: task tf:<action>:<env>
# Examples: task tf:init:dev, task tf:plan:prod, task tf:apply:dev
version: "3"

vars:
  TF_DIR: infrastructure

tasks:
  # ============================================================================
  # Terraform Commands
  # ============================================================================
  # Usage: task tf:<action>:<env>
  # Examples: task tf:init:dev, task tf:plan:prod, task tf:apply:dev
  # Available actions: init, plan, apply, destroy, output
  # Environments are auto-discovered from infrastructure/environments/

  # Dispatcher task - routes tf:<action>:<env> to internal tasks
  tf:*:*:
    desc: "Terraform commands (usage: task tf:<action>:<env> -- [extra args])"
    vars:
      ACTION: "{{index .MATCH 0}}"
      ENV: "{{index .MATCH 1}}"
    cmds:
      - task: _tf:{{.ACTION}}
        vars: { ENV: "{{.ENV}}", EXTRA_ARGS: "{{.CLI_ARGS}}" }

  # Common Terraform Tasks (no environment required)
  tf:fmt:
    desc: Format Terraform files
    dir: "{{.TF_DIR}}"
    cmds:
      - terraform fmt -recursive

  tf:validate:
    desc: Validate Terraform configuration (run after init)
    dir: "{{.TF_DIR}}"
    cmds:
      - terraform validate

  tf:envs:
    desc: List available environments
    cmds:
      - |
        echo "Available environments:"
        ls -1 {{.TF_DIR}}/environments/ | grep -v '^\.' | while read env; do
          echo "  - $env"
        done

  # ============================================================================
  # Backend Commands
  # ============================================================================

  backend:install:
    desc: Install backend Python dependencies with uv
    dir: backend
    cmds:
      - uv venv
      - uv pip install -e ".[dev]"

  backend:dev:
    desc: Run backend in development mode
    dir: backend
    cmds:
      - source .venv/bin/activate && python -m uvicorn src.api_app:app --reload --port 3001

  backend:test:
    desc: Run backend tests
    dir: backend
    cmds:
      - source .venv/bin/activate && pytest

  backend:test:coverage:
    desc: Run backend tests with coverage
    dir: backend
    cmds:
      - source .venv/bin/activate && pytest --cov=src --cov-report=html

  backend:lint:
    desc: Lint backend code
    dir: backend
    cmds:
      - source .venv/bin/activate && ruff check src tests

  backend:typecheck:
    desc: Type check backend code
    dir: backend
    cmds:
      - source .venv/bin/activate && mypy src

  # ============================================================================
  # Frontend Commands
  # ============================================================================

  frontend:install:
    desc: Install frontend dependencies with Yarn Berry
    dir: frontend
    cmds:
      - yarn install

  frontend:dev:
    desc: Run frontend in development mode
    dir: frontend
    cmds:
      - yarn dev

  frontend:build:
    desc: Build frontend for production
    dir: frontend
    cmds:
      - yarn build

  frontend:test:
    desc: Run frontend unit tests
    dir: frontend
    cmds:
      - yarn test

  frontend:test:e2e:
    desc: Run frontend E2E tests
    dir: frontend
    cmds:
      - yarn test:e2e

  frontend:lint:
    desc: Lint frontend code
    dir: frontend
    cmds:
      - yarn lint

  # ============================================================================
  # Combined Commands
  # ============================================================================

  install:
    desc: Install all dependencies (backend + frontend)
    cmds:
      - task: backend:install
      - task: frontend:install

  dev:
    desc: Start development servers (backend + frontend)
    deps:
      - backend:dev
      - frontend:dev

  test:
    desc: Run all tests
    cmds:
      - task: backend:test
      - task: frontend:test

  lint:
    desc: Lint all code
    cmds:
      - task: backend:lint
      - task: frontend:lint

  # ============================================================================
  # Type Generation
  # ============================================================================

  types:generate:
    desc: Generate TypeScript types from backend Pydantic models
    dir: backend
    cmds:
      - source .venv/bin/activate && python scripts/generate_types.py

  # ============================================================================
  # Data Seeding
  # ============================================================================

  seed:*:
    desc: "Seed database with test data (usage: task seed:<env>)"
    vars:
      ENV: "{{index .MATCH 0}}"
    dir: backend
    cmds:
      - source .venv/bin/activate && python scripts/seed_data.py --env {{.ENV}}

  # ============================================================================
  # Internal Tasks (reusable templates)
  # ============================================================================

  _tf:init:
    internal: true
    dir: "{{.TF_DIR}}"
    env:
      TF_DATA_DIR: "{{.ROOT_DIR}}/{{.TF_DIR}}/.terraform-{{.ENV}}"
    preconditions:
      - sh: test -d environments/{{.ENV}}
        msg: "Environment '{{.ENV}}' not found. Run 'task tf:envs' to see available environments."
      - sh: test -f environments/{{.ENV}}/backend.hcl
        msg: "Missing environments/{{.ENV}}/backend.hcl"
    cmds:
      - terraform init -backend-config=environments/{{.ENV}}/backend.hcl -reconfigure {{.EXTRA_ARGS}}

  _tf:plan:
    internal: true
    dir: "{{.TF_DIR}}"
    env:
      TF_DATA_DIR: "{{.ROOT_DIR}}/{{.TF_DIR}}/.terraform-{{.ENV}}"
    preconditions:
      - sh: test -d environments/{{.ENV}}
        msg: "Environment '{{.ENV}}' not found. Run 'task tf:envs' to see available environments."
    cmds:
      - terraform plan -var-file=environments/{{.ENV}}/terraform.tfvars.json {{.EXTRA_ARGS}}

  _tf:apply:
    internal: true
    dir: "{{.TF_DIR}}"
    env:
      TF_DATA_DIR: "{{.ROOT_DIR}}/{{.TF_DIR}}/.terraform-{{.ENV}}"
    preconditions:
      - sh: test -d environments/{{.ENV}}
        msg: "Environment '{{.ENV}}' not found. Run 'task tf:envs' to see available environments."
    cmds:
      - terraform apply -var-file=environments/{{.ENV}}/terraform.tfvars.json {{.EXTRA_ARGS}}

  _tf:destroy:
    internal: true
    dir: "{{.TF_DIR}}"
    env:
      TF_DATA_DIR: "{{.ROOT_DIR}}/{{.TF_DIR}}/.terraform-{{.ENV}}"
    preconditions:
      - sh: test -d environments/{{.ENV}}
        msg: "Environment '{{.ENV}}' not found. Run 'task tf:envs' to see available environments."
    cmds:
      - terraform destroy -var-file=environments/{{.ENV}}/terraform.tfvars.json {{.EXTRA_ARGS}}

  _tf:output:
    internal: true
    dir: "{{.TF_DIR}}"
    env:
      TF_DATA_DIR: "{{.ROOT_DIR}}/{{.TF_DIR}}/.terraform-{{.ENV}}"
    preconditions:
      - sh: test -d environments/{{.ENV}}
        msg: "Environment '{{.ENV}}' not found. Run 'task tf:envs' to see available environments."
    cmds:
      - terraform output {{.EXTRA_ARGS}}
